{"version":3,"sources":["webpack:///./src/views/model/mixin-renderer.js","webpack:///./src/api/material.js","webpack:///./src/views/model/preview/components/ModelRenderingProgress.vue?58f0","webpack:///./src/utils/load-d4.js","webpack:///./src/views/model/preview/ModelPurePreviewer.vue?8a32","webpack:///./src/views/model/preview/components/ModelRenderingProgress.vue?38da","webpack:///src/views/model/preview/components/ModelRenderingProgress.vue","webpack:///./src/views/model/preview/components/ModelRenderingProgress.vue?f1ea","webpack:///./src/views/model/preview/components/ModelRenderingProgress.vue","webpack:///src/views/model/preview/ModelPurePreviewer.vue","webpack:///./src/views/model/preview/ModelPurePreviewer.vue?8c33","webpack:///./src/views/model/preview/ModelPurePreviewer.vue","webpack:///./src/views/model/preview/ModelPurePreviewer.vue?2208"],"names":["data","d4","d2","canvasEvent","destroyed","this","methods","instanceD4","D4","canvasDom","canvas","width","height","resolution","window","devicePixelRatio","_getTargetName","event","param","left","getBoundingClientRect","top","clickX","clientX","clickY","clientY","eventType","type","getTargetFromScreen","_initCanvasEvent","keydown","e","shortcutKeys","click","d4Sign","getSign","offsetX","offsetY","ann","annotations","find","_ann","id","showAnnotation","mousedown","controlsMouseMove","signCurrent","mouseMoveRender","controlsMouseUp","render","document","removeEventListener","isStart","controlsMouseDown","addEventListener","wheel","preventDefault","stopPropagation","controlsMouseWheel","touchstart","controlsTouchMove","controlsTouchEnd","uploadMaterialInfo","axios","method","url","headers","groupAppId","workspaceId","getMaterialInfo","materialId","language","params","fetchMaterialTypes","businessTypes","loadD4","default","loadD2","_vm","_h","$createElement","_c","_self","staticClass","_g","ref","attrs","renderingProgressInfo","staticRenderFns","_v","_s","parseInt","info","loaded","total","current","_e","name","props","Object","required","visible","watch","handler","succeeded","$emit","deep","component","components","ModelRenderingProgress","modelId","String","mode","initModelStatus","Boolean","mixins","resizeModelPreviewer","material","parentElement","clientWidth","clientHeight","resizeRenderer"],"mappings":"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","file":"js/chunk-6ef38988.6c76971b.js","sourcesContent":["export default {\n  data() {\n    return {\n      d4: null,\n      d2: null,\n      canvasEvent: {},\n    };\n  },\n  destroyed() {\n    this.d4 = null;\n    this.d2 = null;\n  },\n  methods: {\n    // 实例化 D4\n    instanceD4(D4, canvasDom) {\n      // eslint-disable-next-line\n      return new D4({\n        canvas: canvasDom,\n        width: canvasDom.width,\n        height: canvasDom.height,\n        resolution: window.devicePixelRatio,\n      });\n    },\n    // 返回当前选中的部件名称\n    _getTargetName(canvasDom, event) {\n      const param = {\n        left: canvasDom.getBoundingClientRect().left,\n        top: canvasDom.getBoundingClientRect().top,\n        clickX: event.clientX,\n        clickY: event.clientY,\n        eventType: event.type,\n      };\n      return this.d4.getTargetFromScreen(param);\n    },\n    // 初始化 canvas 事件，（必须在 D4 创建实例后）\n    _initCanvasEvent() {\n      const {\n        d4,\n      } = this;\n      return ({\n        keydown(e) {\n          d4.shortcutKeys(e);\n        },\n        click: async (e) => {\n          const d4Sign = d4.getSign(e.offsetX, e.offsetY);\n\n          if (d4Sign) {\n            const ann = this.annotations.find(_ann => _ann.id === d4Sign.id);\n            if (ann) {\n              this.showAnnotation(ann);\n            }\n          }\n        },\n        mousedown: (event) => {\n          const controlsMouseMove = (e) => {\n            this.signCurrent = null;\n            d4.controlsMouseMove(e);\n            d4.mouseMoveRender(e);\n          };\n\n          function controlsMouseUp() {\n            d4.controlsMouseUp();\n            d4.render();\n            document.removeEventListener('mousemove', controlsMouseMove, false);\n            document.removeEventListener('mouseup', controlsMouseUp, false);\n          }\n\n          const isStart = d4.controlsMouseDown(event);\n          if (isStart) {\n            document.addEventListener('mousemove', controlsMouseMove, false);\n            document.addEventListener('mouseup', controlsMouseUp, false);\n          }\n        },\n        wheel: (event) => {\n          this.signCurrent = null;\n          event.preventDefault();\n          event.stopPropagation();\n\n          d4.controlsMouseWheel(event);\n          d4.render();\n        },\n        // drop(e){\n        // this.partSelected = _getTargetName(e);\n        // this.updateMaterial(this.$root.draggingData.datum.relateId);\n        // this.$root.draggingData = null;\n        // },\n        touchstart: () => {\n          const controlsTouchMove = (e) => {\n            this.signCurrent = null;\n            d4.controlsTouchMove(e);\n          };\n\n          function controlsTouchEnd(e) {\n            d4.controlsTouchEnd(e);\n\n            document.removeEventListener('touchmove', controlsTouchMove, false);\n            document.removeEventListener('touchend', controlsTouchEnd, false);\n          }\n\n          document.addEventListener('touchmove', controlsTouchMove, false);\n          document.addEventListener('touchend', controlsTouchEnd, false);\n        },\n      });\n    },\n  },\n};\n","import axios from './axios';\n\n/**\n * 上传材质信息(deprecated)\n * @param {Object} data 模型信息对象（具体数据结构看API接口文档）\n * @param {String} groupAppId workspaceId,默认为空\n * @returns {Promise}\n */\nexport const uploadMaterial = (data, groupAppId = '') => {\n  return axios({\n    method: 'post',\n    url: '/show/material/upload',\n    headers: {\n      groupAppId,\n    },\n    data,\n  });\n};\n\n/**\n * 上传材质信息\n * @param {Object} data 模型信息对象（具体数据结构看API接口文档）\n * @param {String} groupAppId workspaceId,默认为空\n * @see http://yapi.4dshoetech.local/project/115/interface/api/6110\n */\nexport const uploadMaterialInfo = (data) => {\n  return axios({\n    method: 'post',\n    url: '/bff-center/showCommon/upload',\n    headers: {\n      groupAppId: data.workspaceId || '',\n    },\n    data,\n  });\n};\n\n/**\n * 获取材质详情信息\n * @param {String} materialId 材质Id\n * @see http://yapi.4dshoetech.local/project/115/interface/api/6026\n */\nexport const getMaterialInfo = (materialId, language, groupAppId) => {\n  return axios({\n    method: 'get',\n    url: '/bff-center/showCommon/getMaterialBasicInfoAndTags',\n    headers: {\n      language,\n      groupAppId,\n    },\n    params: { materialId },\n  });\n};\n\n/**\n * 获取材质详情信息，用于拖拽到鞋模型渲染时使用(deprecated)\n * @param {String} relateId 材质Id\n * @returns {Promise}\n */\nexport const getMaterialInfoForDrag = (relateId) => {\n  return axios({\n    method: 'get',\n    url: '/catalogue/appInteraction/getMaterialDetailInfo',\n    params: {\n      relateId,\n    },\n  });\n};\n\n/**\n * 更新材质详情信息（标签更新在其他接口）\n * @param {String} data { id: string, propName: any }\n * @see {Promise}\n */\nexport const updateMaterialInfo = (data) => {\n  return axios({\n    method: 'post',\n    url: '/bff-center/showCommon/updateNewMaterialInfo',\n    data,\n  });\n};\n\n/* ============================ 材质标签相关 ======================= */\n/**\n * 新增材质标签\n * @param {String} id 材质ID\n * @param {Array} tags 新添加的标签数组\n * @param {String} groupAppId workspaceId,默认为空\n * @returns {Promise}\n */\nexport const createNewTagForMaterial = (id, tags, groupAppId = '') => {\n  return axios({\n    method: 'post',\n    url: '/show/tag/addMaterialTag',\n    headers: {\n      groupAppId,\n    },\n    data: {\n      id,\n      tags,\n    },\n  });\n};\n\n/**\n * 删除材质标签\n * @param {String} id 材质ID\n * @param {Array} tags 新添加的标签数组\n * @param {String} groupAppId workspaceId,默认为空\n * @returns {Promise}\n */\nexport const deleteTagsOfMaterial = (id, tags, groupAppId = '') => {\n  return axios({\n    method: 'post',\n    url: '/show/tag/deleteMaterialTag',\n    headers: {\n      groupAppId,\n    },\n    data: {\n      id,\n      tags,\n    },\n  });\n};\n\n// ==============================================================\n\n// 查询类目列表(无分页)\nexport const fetchMaterialTypes = async (id = '-1', businessTypes = 1) => {\n  let data = null;\n  switch (businessTypes) {\n    case 1: {\n      data = (await axios({\n        method: 'get',\n        url: `/anta-material/category/list?parentId=${id}`,\n      })).data;\n      break;\n    }\n    case 0: {\n      data = (await axios({\n        method: 'get',\n        url: `/show/category/list?parentId=${id}`,\n      })).data;\n      break;\n    }\n    default:\n  }\n  return data;\n};\n","export * from \"-!../../../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ModelRenderingProgress.vue?vue&type=style&index=0&id=f2f94be0&lang=scss&scoped=true&\"","/* 用于加载D4.js */\nexport const loadD4 = async () => (await import('@4dst-render/d4.js/dist/D4')).default;\nexport const loadD2 = async () => (await import('@4dst-render/d4.js/dist/D2')).default;\nexport default loadD4;\n","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{staticClass:\"model-pure-previewer\"},[_c('canvas',_vm._g({ref:\"renderer\"},_vm.canvasEvent)),_c('ModelRenderingProgress',{attrs:{\"info\":_vm.renderingProgressInfo}})],1)}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return (_vm.visible)?_c('div',{staticClass:\"model-rendering-progress\"},[_c('div',{staticClass:\"progress-info\"},[_c('span',[_vm._v(_vm._s(parseInt(_vm.info.loaded / _vm.info.total * 100, 10))+\"%\")]),_c('span',[_vm._v(_vm._s(((_vm.info.loaded) + \"/\" + (_vm.info.total))))])]),_c('p',{staticClass:\"loading-component-name text-one-line\"},[_vm._v(_vm._s(_vm.info.current || ''))])]):_vm._e()}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","\n<template>\n  <div v-if=\"visible\" class=\"model-rendering-progress\">\n    <div class=\"progress-info\">\n      <span>{{ parseInt(info.loaded / info.total * 100, 10) }}%</span>\n      <span>{{ `${info.loaded}/${info.total}` }}</span>\n    </div>\n    <p class=\"loading-component-name text-one-line\">{{ info.current || '' }}</p>\n  </div>\n</template>\n\n<script>\nexport default {\n  name: 'ModelRenderingProgress',\n  props: {\n    info: {\n      type: Object,\n      required: true,\n    },\n  },\n  data() {\n    return {\n      visible: false,\n    };\n  },\n  watch: {\n    info: {\n      handler(info) {\n        this.visible = true;\n        if (info.total === info.succeeded) {\n          this.visible = false;\n          this.$emit('complished');\n        }\n      },\n      deep: true,\n    },\n  },\n};\n</script>\n\n<style lang=\"scss\" scoped>\n/deep/ .el-progress__text {\n  color: #fff;\n}\n\n.model-rendering-progress {\n  background-color: rgba(0, 0, 0, 0.6);\n  border-radius: 6px;\n  padding: 25px;\n  width: 460px;\n  height: 80px;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  top: 0;\n  position: absolute;\n  margin: auto auto;\n      color: #fff;\n  .progress-info {\n    display: flex;\n    justify-content: space-between;\n    width: 100%;\n  }\n\n  .loading-component-name {\n    opacity: 0;\n    margin-top: 6px;\n  }\n}\n</style>\n","import mod from \"-!../../../../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../../../../node_modules/thread-loader/dist/cjs.js!../../../../../node_modules/babel-loader/lib/index.js!../../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ModelRenderingProgress.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../../../../node_modules/thread-loader/dist/cjs.js!../../../../../node_modules/babel-loader/lib/index.js!../../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ModelRenderingProgress.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./ModelRenderingProgress.vue?vue&type=template&id=f2f94be0&scoped=true&\"\nimport script from \"./ModelRenderingProgress.vue?vue&type=script&lang=js&\"\nexport * from \"./ModelRenderingProgress.vue?vue&type=script&lang=js&\"\nimport style0 from \"./ModelRenderingProgress.vue?vue&type=style&index=0&id=f2f94be0&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"f2f94be0\",\n  null\n  \n)\n\nexport default component.exports","<template>\n  <div class=\"model-pure-previewer\">\n    <canvas ref=\"renderer\" v-on=\"canvasEvent\" />\n\n    <!-- 渲染进度条 -->\n    <ModelRenderingProgress :info=\"renderingProgressInfo\" />\n  </div>\n</template>\n\n<script>\nimport Vue from 'vue';\nimport i18n from 'i18next';\nimport { debounce } from 'throttle-debounce';\nimport axios from '@/utils/axios';\nimport mixinRenderer from '@/views/model/mixin-renderer';\n\nimport { normalizeComponent, normalizeMaterial } from '@/utils/normalize-component';\nimport { loadD4 } from '@/utils/load-d4';\nimport { getMaterialInfo } from '@/api/material';\nimport { getItem } from '@/utils/oss/utils';\nimport { dataUrl2Blob } from '_/blob-utils';\nimport { OSSUploader } from '@/utils/oss/uploader';\n\nimport AppError from '@/utils/error';\nimport ModelRenderingProgress from './components/ModelRenderingProgress';\n\n// const getModelComponentList = (modelId) => {\n//   return axios({\n//     method: 'get',\n//     url: '/bff-center/showCommon/modelComponentSearch/getShoeDefaultComponent',\n//     headers: { 'Resource-Checkout': false },\n//     params: { modelId },\n//   });\n// };\n\nconst getModelCTMList = (modelId) => {\n  return axios({\n    method: 'get',\n    url: 'show/application/model/ctms',\n    params: { modelId },\n    headers: {\n      'Resource-Checkout': true,\n      'requester-type': 'web',\n      'model-type': 'SHOE',\n    },\n  });\n};\n\n\nexport default Vue.extend({\n  name: 'ModelPurePreviewer',\n  components: {\n    ModelRenderingProgress,\n  },\n  props: {\n    modelId: {\n      type: String,\n      required: true,\n    },\n    materialId: {\n      type: String,\n      default: '',\n    },\n    mode: {\n      type: String,\n      default: 'pureModel', // pureModel, modelMaterial\n    },\n    initModelStatus: {\n      type: Boolean,\n      default: true,\n    },\n    groupAppId: {\n      type: String,\n    },\n  },\n  mixins: [mixinRenderer],\n  async mounted() {\n    window.addEventListener('resize', this.resizeModelPreviewer);\n    await this.initD4();\n  },\n  destroyed() {\n    window.removeEventListener('resize', this.resizeModelPreviewer);\n  },\n  data() {\n    return {\n      renderingProgressInfo: {}, // 记录模型渲染过程中的信息\n      material: {},\n    };\n  },\n  methods: {\n    async initD4() {\n      const [data, D4] = await Promise.all([\n        this._getModelData(this.modelId),\n        loadD4(),\n      ]);\n      const canvasDom = this.$refs.renderer;\n\n      canvasDom.width = canvasDom.parentElement.clientWidth;\n      canvasDom.height = canvasDom.parentElement.clientHeight;\n\n      const params = {\n        canvas: canvasDom,\n        width: canvasDom.clientWidth,\n        height: canvasDom.clientHeight,\n        resolution: window.devicePixelRatio,\n      };\n\n      this.d4 = new D4(params);\n      this.canvasEvent = this._initCanvasEvent();\n\n      if (this.initModelStatus) await this.initModel(data);\n    },\n    async initModel(data) {\n      try {\n        // 如果有material参数传入，把鞋款所有的部件的面料更换为当前传入的面料\n        if (this.mode === 'modelMaterial') await this._replaceMaterialInComponents(data);\n        if (!this.d4) {\n          return;\n        }\n        await this.d4.loadModel(data,\n          (info) => {\n            this.renderingProgressInfo = info;\n          });\n\n        // 每次都判断是否有缓存，否则截图\n        const coverObj = JSON.parse(localStorage.getItem('modelCovers')) || {};\n        if (this.mode === 'modelMaterial' && !(this.modelId in coverObj)) {\n          coverObj[this.modelId] = await this.getModelCover();\n          localStorage.setItem('modelCovers', JSON.stringify(coverObj));\n        }\n      } catch (err) {\n        this.$errHandler(err);\n      }\n    },\n    // 重新加载模型\n    async reloadModel(modelId) {\n      const modelComponents = await this._getModelData(modelId);\n      // 面料在加载模型前替换\n      await this._replaceMaterialInComponents(modelComponents);\n      if (!this.d4) throw AppError.abort;\n      await this.d4.loadModel(modelComponents, (info) => {\n        this.renderingProgressInfo = info;\n      });\n\n      const snapshot = await this.getModelCover();\n      return snapshot;\n    },\n    // 获取鞋款的截图\n    async getModelCover() {\n      const uploader = new OSSUploader({ sourceType: 'SHOE', sendAs: 'arrayBuffer' });\n      if (!this.d4) throw AppError.abort;\n      const file = dataUrl2Blob(this.d4.getModelSnapshot(512, 512));\n      const { key } = await getItem(file, { sourceType: 'SHOE' });\n      // 上传到oss\n      await uploader.send({\n        params: { key },\n        body: file,\n        headers: {\n          'Content-Type': 'image/png',\n        },\n      });\n      return key;\n    },\n    resizeModelPreviewer: debounce(500, function resize() {\n      if (this.d4) {\n        const canvasDom = this.$refs.renderer;\n\n        const params = {\n          canvas: canvasDom,\n          width: canvasDom.parentElement.clientWidth,\n          height: canvasDom.parentElement.clientHeight,\n          resolution: window.devicePixelRatio,\n        };\n        canvasDom.width = params.width;\n        canvasDom.height = params.height;\n        this.d4.resizeRenderer(params.width, params.height, params.resolution);\n      }\n    }),\n    // 获取鞋模型数据并对部件初始化\n    async _getModelData(modelId) {\n      const { data } = await getModelCTMList(modelId);\n      return Promise.all(data.map((item) => normalizeComponent(item)));\n    },\n    // 更换鞋款全部部件上面料的信息\n    async _replaceMaterialInComponents(components) {\n      this.material = await normalizeMaterial((await getMaterialInfo(this.materialId, i18n.language)).data);\n\n      components.filter(c => !c.material).forEach(comp => {\n        comp.material = this.material;\n\n        // 更换获取ctm接口后部分字段修改\n        comp.shoeId = comp.modelId;\n        comp.componentID = comp.ctmId;\n        comp.componentName = comp.ctmName;\n        comp.url = comp.ctmPath;\n      });\n    },\n  },\n});\n</script>\n\n<style lang=\"scss\" scoped>\n.model-pure-previewer {\n  width: 100%;\n  height: 100%;\n  > canvas {\n    width: 100%;\n    height: 100%;\n  }\n}\n</style>\n","import mod from \"-!../../../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../../../node_modules/thread-loader/dist/cjs.js!../../../../node_modules/babel-loader/lib/index.js!../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ModelPurePreviewer.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../../../node_modules/thread-loader/dist/cjs.js!../../../../node_modules/babel-loader/lib/index.js!../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ModelPurePreviewer.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./ModelPurePreviewer.vue?vue&type=template&id=3da2b074&scoped=true&\"\nimport script from \"./ModelPurePreviewer.vue?vue&type=script&lang=js&\"\nexport * from \"./ModelPurePreviewer.vue?vue&type=script&lang=js&\"\nimport style0 from \"./ModelPurePreviewer.vue?vue&type=style&index=0&id=3da2b074&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"3da2b074\",\n  null\n  \n)\n\nexport default component.exports","export * from \"-!../../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ModelPurePreviewer.vue?vue&type=style&index=0&id=3da2b074&lang=scss&scoped=true&\""],"sourceRoot":""}